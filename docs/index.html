<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Storico ESP32 – Grafici</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:12px;background:#0b0f14;color:#e6e6e6}
    .card{background:#131c26;border:1px solid #22303d;border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,input,button{background:#0f151c;border:1px solid #334556;color:#e6e6e6;border-radius:10px;padding:6px 10px}
    button{cursor:pointer}
    label{opacity:.85}
    canvas{background:#fff;border-radius:10px}
  </style>
</head>
<body>
  <h2>Storico ESP32 – Grafici (via GitHub Actions)</h2>

  <div class="card">
    <div class="row">
      <label>Metrica 1</label><select id="m1"></select>
      <label>Metrica 2</label><select id="m2"></select>
      <label>Metrica 3</label><select id="m3"></select>
      <label>Finestra</label>
      <select id="win">
        <option value="1">Ultimo giorno</option>
        <option value="3">Ultimi 3 giorni</option>
        <option value="7" selected>Ultimi 7 giorni</option>
        <option value="30">Ultimi 30 giorni</option>
        <option value="0">Tutto</option>
      </select>
      <button id="refresh">Aggiorna</button>
      <small class="row">Fonte: <code id="src"></code></small>
    </div>
  </div>

  <div class="card"><canvas id="c1" height="240"></canvas></div>
  <div class="card"><canvas id="c2" height="240"></canvas></div>
  <div class="card"><canvas id="c3" height="240"></canvas></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // === CONFIG: imposta il tuo repo ===
  const RAW_CSV_URL = "https://github.com/samuele9581/esp32-keepalive/blob/main/states/metrics.csv";

  document.getElementById('src').textContent = RAW_CSV_URL;

  // util
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const parseCSV = (text) => {
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return { header: [], rows: [] };
    const header = lines[0].split(',').map(h => h.trim());
    const rows = lines.slice(1).map(line => {
      const cells = line.split(',').map(c => c.trim());
      const obj = {};
      header.forEach((h,i) => obj[h] = cells[i] ?? "");
      return obj;
    });
    return { header, rows };
  };

  // fetch CSV (con piccolo cache-buster)
  async function fetchCSV(url){
    const u = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
    const r = await fetch(u);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.text();
  }

  let charts = [];
  function destroyCharts(){ charts.forEach(ch=>ch.destroy()); charts = []; }

  function buildSelects(header){
    const metrics = header.filter(h => h!=='timestamp' && h!=='time' && h!=='ts');
    const fill = (id, def) => {
      const sel = document.getElementById(id);
      sel.innerHTML = '<option value="">—</option>' + metrics.map(m=>`<option>${m}</option>`).join('');
      if (metrics.includes(def)) sel.value = def;
    };
    // piccoli default sensati
    fill('m1', metrics.includes('soil1')?'soil1':metrics[0]);
    fill('m2', metrics.includes('soil2')?'soil2':(metrics[1]||''));
    fill('m3', metrics.includes('bme_voc')?'bme_voc':(metrics[2]||''));
  }

  function filterWindow(rows, days){
    if(!days || days<=0) return rows;
    const now = Date.now();
    const from = now - days*24*3600*1000;
    return rows.filter(r => {
      const t = Date.parse(r.timestamp || r.time || r.ts || "");
      return isFinite(t) && t >= from;
    });
  }

  function toSeries(rows, key){
    const pts = [];
    for(const r of rows){
      const t = Date.parse(r.timestamp || r.time || r.ts || "");
      const v = parseFloat(r[key]);
      if (isFinite(t) && isFinite(v)) pts.push({x: new Date(t), y: v});
    }
    return pts.sort((a,b)=>a.x-b.x);
  }

  function drawChart(canvasId, label, points){
    const ctx = document.getElementById(canvasId).getContext('2d');
    const ch = new Chart(ctx, {
      type: 'line',
      data: { datasets: [ { label, data: points, tension: 0.15, pointRadius: 0 } ] },
      options: {
        animation: false,
        parsing: false,
        scales: {
          x: { type: 'time', time: { unit: 'hour' } },
          y: { beginAtZero: false }
        },
        plugins: { legend: { display: true } }
      }
    });
    charts.push(ch);
  }

  async function render(){
    try{
      const csv = await fetchCSV(RAW_CSV_URL);
      const { header, rows } = parseCSV(csv);
      if (!header.length || !rows.length){ alert('CSV vuoto'); return; }

      // popola select solo la prima volta
      if (!document.getElementById('m1').options.length) buildSelects(header);

      const days = +document.getElementById('win').value;
      const filtered = filterWindow(rows, days);

      const k1 = document.getElementById('m1').value;
      const k2 = document.getElementById('m2').value;
      const k3 = document.getElementById('m3').value;

      destroyCharts();

      if (k1){ drawChart('c1', k1, toSeries(filtered, k1)); }
      if (k2){ drawChart('c2', k2, toSeries(filtered, k2)); }
      if (k3){ drawChart('c3', k3, toSeries(filtered, k3)); }
    } catch(e){
      console.error(e);
      alert('Errore caricamento CSV: ' + e.message);
    }
  }

  document.getElementById('refresh').addEventListener('click', render);

  // primo render + auto-refresh ogni 5 minuti
  render();
  setInterval(render, 5*60*1000);
  </script>
</body>
</html>
